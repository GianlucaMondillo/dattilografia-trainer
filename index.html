<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dattilografia Pro - Gaming Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --theme-primary: #667eea;
            --theme-secondary: #764ba2;
            --bg-color: #0a0a0a;
            --text-color: #ffffff;
            --accent-color: #00ffff;
        }

        /* TEMI DINAMICI */
        body.theme-default {
            --theme-primary: #667eea;
            --theme-secondary: #764ba2;
            --bg-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body.theme-cyberpunk {
            --theme-primary: #ff00ff;
            --theme-secondary: #00ffff;
            --bg-color: #0a0a0a;
            --text-color: #00ff00;
            --accent-color: #ff00ff;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a0033 100%);
        }

        body.theme-cyberpunk::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                repeating-linear-gradient(
                    0deg,
                    rgba(255, 0, 255, 0.03) 0px,
                    transparent 1px,
                    transparent 2px,
                    rgba(255, 0, 255, 0.03) 3px
                );
            pointer-events: none;
            z-index: 1;
        }

        body.theme-nature {
            --theme-primary: #4caf50;
            --theme-secondary: #8bc34a;
            --bg-color: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            --text-color: #2e7d32;
        }

        body.theme-space {
            --theme-primary: #4a148c;
            --theme-secondary: #311b92;
            --bg-color: #000428;
            --text-color: #ffffff;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
        }

        body.theme-ocean {
            --theme-primary: #006064;
            --theme-secondary: #00acc1;
            --bg-color: linear-gradient(180deg, #0077be 0%, #004d7a 100%);
            --text-color: #e0f7fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* ANIMAZIONI BACKGROUND */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.5;
        }

        .theme-space .stars {
            position: fixed;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        .theme-space .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .theme-nature .leaf {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #8bc34a;
            border-radius: 0 100% 0 100%;
            animation: fall 10s infinite linear;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .theme-ocean .bubble {
            position: absolute;
            bottom: -50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: rise 10s infinite;
        }

        @keyframes rise {
            to {
                transform: translateY(-100vh);
                opacity: 0;
            }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1400px;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        .theme-cyberpunk .container {
            background: rgba(10, 10, 10, 0.95);
            color: #00ff00;
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 30px var(--accent-color);
        }

        .theme-nature .container {
            color: #2e7d32;
        }

        .theme-space .container {
            color: #ffffff;
        }

        .theme-ocean .container {
            color: #e0f7fa;
        }

        /* HEADER CON SISTEMA XP */
        .header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .theme-cyberpunk h1 {
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-1px, 1px); }
            40% { transform: translate(-1px, -1px); }
            60% { transform: translate(1px, 1px); }
            80% { transform: translate(1px, -1px); }
        }

        /* PLAYER STATS SECTION */
        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .player-info::after {
            display: none;
        }

        .player-level {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .level-badge {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: bold;
            border: 3px solid gold;
            position: relative;
        }

        .level-badge::before {
            content: '‚≠ê';
            position: absolute;
            top: -10px;
            right: -5px;
            font-size: 0.8em;
        }

        .player-title {
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .xp-bar {
            flex: 1;
            margin: 0 30px;
        }

        .xp-progress {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            height: 30px;
            position: relative;
            overflow: hidden;
        }

        .xp-fill {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            height: 100%;
            border-radius: 20px;
            transition: width 0.5s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .xp-fill::after {
            display: none;
        }

        .xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        /* COMBO SYSTEM */
        .combo-display {
            position: fixed;
            top: 50px;
            right: 50px;
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            display: none;
            animation: comboAppear 0.5s ease;
            z-index: 1000;
        }

        .combo-display.active {
            display: block;
        }

        @keyframes comboAppear {
            from {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .combo-multiplier {
            font-size: 2em;
            color: gold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* THEME SELECTOR */
        .theme-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .theme-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .theme-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .theme-btn:hover::before {
            width: 100px;
            height: 100px;
        }

        .theme-btn.active {
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
            border: 2px solid rgba(102, 126, 234, 0.8);
        }

        .theme-default { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .theme-cyber { background: linear-gradient(135deg, #ff00ff, #00ffff); color: white; }
        .theme-nat { background: linear-gradient(135deg, #4caf50, #8bc34a); color: white; }
        .theme-sp { background: linear-gradient(135deg, #4a148c, #311b92); color: white; }
        .theme-oc { background: linear-gradient(135deg, #006064, #00acc1); color: white; }

        /* MASCOTTE */
        .mascot-container {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 100;
        }

        .mascot {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #ffd93d, #ff6b6b);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mascot:hover {
            transform: scale(1.1);
        }

        .mascot-eyes {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }

        .eye {
            width: 15px;
            height: 15px;
            background: black;
            border-radius: 50%;
            position: relative;
        }

        .eye::after {
            content: '';
            position: absolute;
            width: 5px;
            height: 5px;
            background: white;
            border-radius: 50%;
            top: 2px;
            right: 2px;
        }

        .mascot-mouth {
            position: absolute;
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 15px;
            border-bottom: 3px solid black;
            border-radius: 0 0 30px 30px;
        }

        .mascot.happy .mascot-mouth {
            border-radius: 30px 30px 0 0;
            border-bottom: none;
            border-top: 3px solid black;
        }

        .mascot.sad .mascot-mouth {
            border-radius: 0 0 30px 30px;
            transform: translateX(-50%) scaleY(0.5);
        }

        .mascot.excited {
            animation: spin 1s;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .mascot-speech {
            position: absolute;
            bottom: 110px;
            left: 0;
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            white-space: nowrap;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s;
        }

        .mascot-speech.show {
            opacity: 1;
            transform: scale(1);
        }

        .mascot-speech::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid white;
        }

        /* STATS CON ANIMAZIONI */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-box::before {
            display: none;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: bold;
            margin-top: 5px;
            position: relative;
            z-index: 1;
        }

        .stat-value.updating {
            color: #ffd700;
            transition: color 0.3s ease;
        }

        /* PARTICLE EFFECTS */
        .particle {
            position: fixed;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
        }

        .particle.star {
            color: gold;
            font-size: 20px;
            animation: starBurst 1s ease-out;
        }

        @keyframes starBurst {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(0);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x), var(--y)) scale(1.5);
            }
        }

        .particle.heart {
            color: #ff6b6b;
            font-size: 20px;
            animation: heartFloat 2s ease-out;
        }

        @keyframes heartFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5) rotate(15deg);
            }
        }

        /* TEXT DISPLAY */
        .text-display {
            background: rgba(248, 249, 250, 0.9);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.3em;
            line-height: 1.8;
            min-height: 150px;
            position: relative;
            font-family: 'Courier New', monospace;
            backdrop-filter: blur(10px);
        }

        .theme-cyberpunk .text-display {
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid var(--accent-color);
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }

        .text-display span {
            transition: all 0.1s;
            position: relative;
        }

        .text-display .correct {
            color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        .text-display .correct::after {
            display: none;
        }

        .text-display .incorrect {
            color: #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        .text-display .current {
            background: #ffeb3b;
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
        }

        /* INPUT AREA */
        .input-area {
            margin-bottom: 30px;
            position: relative;
        }

        .typing-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        .typing-input:focus {
            border-color: var(--theme-primary);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .theme-cyberpunk .typing-input {
            background: rgba(10, 10, 10, 0.9);
            color: #00ff00;
            border-color: var(--accent-color);
        }

        /* SETTINGS CONTROLS */
        .settings-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .settings-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .settings-row label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: white;
        }

        .settings-row select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1em;
            background: white;
        }

        /* CONTROLS */
        .controls {
            text-align: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 10px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* SOUND TOGGLE */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            z-index: 100;
        }

        .sound-toggle:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .sound-toggle.muted {
            background: #f44336;
            color: white;
        }

        /* PROGRESS BAR */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            transition: width 0.3s;
            position: relative;
        }

        .progress-fill::after {
            display: none;
        }

        /* LEVEL UP ANIMATION */
        .level-up-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            pointer-events: none;
            display: none;
        }

        .level-up-animation.show {
            display: block;
            animation: levelUpBurst 2s ease-out;
        }

        @keyframes levelUpBurst {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2) rotate(360deg);
                opacity: 0;
            }
        }

        .level-up-text {
            font-size: 4em;
            font-weight: bold;
            color: gold;
            text-shadow:
                0 0 10px rgba(255, 215, 0, 0.5),
                0 0 20px rgba(255, 215, 0, 0.5),
                0 0 30px rgba(255, 215, 0, 0.5);
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalAppear 0.5s ease;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .rewards-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .reward-item {
            padding: 15px;
            background: linear-gradient(135deg, gold, #ffd700);
            border-radius: 10px;
        }

        /* NAVIGATION STYLES */
        .main-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            background: #f0f0f0;
            color: #333;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
        }

        .nav-btn:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .section {
            display: none;
            margin-top: 30px;
        }

        .section.active {
            display: block;
        }

        /* ANALYTICS STYLES */
        .analytics-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .analytics-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        /* HEATMAP STYLES */
        .heatmap-keyboard {
            margin: 20px 0;
        }

        .heatmap-row {
            display: flex;
            justify-content: center;
            gap: 3px;
            margin-bottom: 5px;
        }

        .heatmap-key {
            min-width: 35px;
            height: 35px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .heatmap-key.error-0 { background: #e8f5e8; }
        .heatmap-key.error-1 { background: #fff3cd; }
        .heatmap-key.error-2 { background: #fd79a8; }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        /* GAME MODES STYLES */
        .game-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-card:hover {
            border-color: var(--theme-primary);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .mode-card.selected {
            border-color: var(--theme-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .mode-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .mode-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .mode-description {
            color: #666;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .mode-settings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .mode-settings label {
            font-size: 0.9em;
            color: #555;
        }

        .mode-settings select {
            margin-left: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* TEXT CATEGORIES */
        .text-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .category-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .category-card.selected {
            border: 2px solid var(--theme-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .category-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .category-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .category-count {
            font-size: 0.9em;
            color: #666;
        }

        /* FILE IMPORT */
        .import-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .import-area:hover {
            border-color: var(--theme-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .file-input {
            display: none;
        }

        .custom-texts {
            margin-top: 20px;
        }

        .custom-text-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .text-preview {
            font-family: monospace;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 400px;
            font-size: 0.9em;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .error-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .error-key {
            font-family: 'Courier New', monospace;
            background: #f5f5f5;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .error-count {
            background: #ff6b6b;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        /* KEYBOARD DISPLAY */
        .keyboard-container {
            background: rgba(248, 249, 250, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .theme-cyberpunk .keyboard-container {
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid var(--accent-color);
        }

        .keyboard-toggle {
            text-align: center;
            margin-bottom: 15px;
        }

        .keyboard {
            display: grid;
            gap: 5px;
            max-width: 800px;
            margin: 20px auto;
        }

        .keyboard-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .key {
            background: white;
            color: #333;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
        }

        .theme-cyberpunk .key {
            background: rgba(10, 10, 10, 0.8);
            color: #00ff00;
            border-color: var(--accent-color);
        }

        .key.space {
            min-width: 200px;
        }

        .key.tab { min-width: 60px; }
        .key.caps { min-width: 70px; }
        .key.shift { min-width: 80px; }
        .key.ctrl { min-width: 50px; }
        .key.alt { min-width: 50px; }
        .key.backspace { min-width: 80px; }
        .key.enter { min-width: 70px; }

        .key.active {
            background: #ffeb3b;
            color: #333;
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.7);
            border-color: #ffeb3b;
        }

        .key.pressed {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .finger-zone {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 0.6em;
            opacity: 0.7;
        }

        .finger-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
            font-size: 0.85em;
        }

        .finger-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .finger-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        /* NOTIFICATION TOAST */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid #4caf50;
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        .notification.info {
            border-left-color: #2196f3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }
    </style>
</head>
<body class="theme-default">
    <!-- Notification container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Background animations -->
    <div class="bg-animation" id="bgAnimation"></div>

    <!-- Sound toggle -->
    <div class="sound-toggle" id="soundToggle" onclick="toggleSound()">
        <span id="soundIcon">üîä</span>
    </div>

    <!-- Combo display -->
    <div class="combo-display" id="comboDisplay">
        <div>COMBO!</div>
        <div class="combo-multiplier">x<span id="comboMultiplier">1</span></div>
    </div>

    <!-- Level up animation -->
    <div class="level-up-animation" id="levelUpAnimation">
        <div class="level-up-text">LEVEL UP!</div>
    </div>

    <!-- Mascot -->
    <div class="mascot-container">
        <div class="mascot" id="mascot" onclick="interactMascot()">
            <div class="mascot-eyes">
                <div class="eye"></div>
                <div class="eye"></div>
            </div>
            <div class="mascot-mouth"></div>
        </div>
        <div class="mascot-speech" id="mascotSpeech"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üéÆ Dattilografia Pro - Gaming Edition</h1>
        </div>

        <!-- Player Info -->
        <div class="player-info">
            <div class="player-level">
                <div class="level-badge" id="levelBadge">1</div>
                <div>
                    <div class="player-title" id="playerTitle">Apprendista Dattilografo</div>
                    <div style="font-size: 0.9em; opacity: 0.8;">Livello <span id="playerLevel">1</span></div>
                </div>
            </div>
            <div class="xp-bar">
                <div class="xp-progress">
                    <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                    <div class="xp-text" id="xpText">0 / 100 XP</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.2em;">üí∞ <span id="coins">0</span></div>
                <div style="font-size: 0.9em;">‚≠ê <span id="totalStars">0</span></div>
            </div>
        </div>

        <!-- Theme selector -->
        <div class="theme-selector">
            <button class="theme-btn theme-default active" onclick="setTheme('default', this)">üé® Classico</button>
            <button class="theme-btn theme-cyber" onclick="setTheme('cyberpunk', this)">ü§ñ Cyberpunk</button>
            <button class="theme-btn theme-nat" onclick="setTheme('nature', this)">üåø Natura</button>
            <button class="theme-btn theme-sp" onclick="setTheme('space', this)">üöÄ Spazio</button>
            <button class="theme-btn theme-oc" onclick="setTheme('ocean', this)">üåä Oceano</button>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">WPM</div>
                <div class="stat-value" id="wpm">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Precisione</div>
                <div class="stat-value" id="accuracy">100%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Combo</div>
                <div class="stat-value" id="combo">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Record</div>
                <div class="stat-value" id="highScore">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Tempo</div>
                <div class="stat-value" id="timer">0:00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Punti</div>
                <div class="stat-value" id="score">0</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%"></div>
        </div>

        <div class="text-display" id="textDisplay">
            Clicca "Inizia" per cominciare la tua avventura!
        </div>

        <div class="input-area">
            <input type="text" class="typing-input" id="typingInput"
                   placeholder="Inizia a digitare qui..." disabled>
        </div>

        <!-- Navigation -->
        <div class="main-nav">
            <button class="nav-btn active" onclick="switchSection('practice')">üéÆ Pratica</button>
            <button class="nav-btn" onclick="switchSection('analytics')">üìä Analytics</button>
            <button class="nav-btn" onclick="switchSection('modes')">üéØ Modalit√†</button>
            <button class="nav-btn" onclick="switchSection('texts')">üìö Testi</button>
        </div>

        <!-- Practice Section -->
        <div class="section active" id="practice-section">
            <div class="settings-controls">
                <div class="settings-row">
                    <label>Difficolt√†:
                        <select id="difficulty">
                            <option value="facile">Facile</option>
                            <option value="medio" selected>Medio</option>
                            <option value="difficile">Difficile</option>
                        </select>
                    </label>
                    <label>Lunghezza:
                        <select id="textLength">
                            <option value="corto">Corto</option>
                            <option value="medio" selected>Medio</option>
                            <option value="lungo">Lungo</option>
                        </select>
                    </label>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startGame()">Inizia</button>
                <button class="btn btn-secondary" onclick="resetGame()">Reset</button>
                <button class="btn btn-secondary" onclick="toggleKeyboard()">Tastiera</button>
                <button class="btn btn-secondary" onclick="showShop()">Negozio</button>
                <button class="btn btn-secondary" onclick="showAchievements()">Trofei</button>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="section" id="analytics-section">
            <div class="analytics-card">
                <div class="analytics-title">üìä Statistiche Dettagliate</div>
                <div id="performance-charts"></div>
            </div>

            <div class="analytics-card">
                <div class="analytics-title">üî• Heatmap Errori</div>
                <div class="heatmap-keyboard">
                    <div class="heatmap-row">
                        <div class="heatmap-key error-0" data-key="`">`</div>
                        <div class="heatmap-key error-0" data-key="1">1</div>
                        <div class="heatmap-key error-0" data-key="2">2</div>
                        <div class="heatmap-key error-0" data-key="3">3</div>
                        <div class="heatmap-key error-0" data-key="4">4</div>
                        <div class="heatmap-key error-0" data-key="5">5</div>
                        <div class="heatmap-key error-0" data-key="6">6</div>
                        <div class="heatmap-key error-0" data-key="7">7</div>
                        <div class="heatmap-key error-0" data-key="8">8</div>
                        <div class="heatmap-key error-0" data-key="9">9</div>
                        <div class="heatmap-key error-0" data-key="0">0</div>
                        <div class="heatmap-key error-0" data-key="-">-</div>
                        <div class="heatmap-key error-0" data-key="=">=</div>
                    </div>
                    <div class="heatmap-row">
                        <div class="heatmap-key error-0" data-key="q">Q</div>
                        <div class="heatmap-key error-0" data-key="w">W</div>
                        <div class="heatmap-key error-0" data-key="e">E</div>
                        <div class="heatmap-key error-0" data-key="r">R</div>
                        <div class="heatmap-key error-0" data-key="t">T</div>
                        <div class="heatmap-key error-0" data-key="y">Y</div>
                        <div class="heatmap-key error-0" data-key="u">U</div>
                        <div class="heatmap-key error-0" data-key="i">I</div>
                        <div class="heatmap-key error-0" data-key="o">O</div>
                        <div class="heatmap-key error-0" data-key="p">P</div>
                    </div>
                    <div class="heatmap-row">
                        <div class="heatmap-key error-0" data-key="a">A</div>
                        <div class="heatmap-key error-0" data-key="s">S</div>
                        <div class="heatmap-key error-0" data-key="d">D</div>
                        <div class="heatmap-key error-0" data-key="f">F</div>
                        <div class="heatmap-key error-0" data-key="g">G</div>
                        <div class="heatmap-key error-0" data-key="h">H</div>
                        <div class="heatmap-key error-0" data-key="j">J</div>
                        <div class="heatmap-key error-0" data-key="k">K</div>
                        <div class="heatmap-key error-0" data-key="l">L</div>
                    </div>
                    <div class="heatmap-row">
                        <div class="heatmap-key error-0" data-key="z">Z</div>
                        <div class="heatmap-key error-0" data-key="x">X</div>
                        <div class="heatmap-key error-0" data-key="c">C</div>
                        <div class="heatmap-key error-0" data-key="v">V</div>
                        <div class="heatmap-key error-0" data-key="b">B</div>
                        <div class="heatmap-key error-0" data-key="n">N</div>
                        <div class="heatmap-key error-0" data-key="m">M</div>
                        <div class="heatmap-key error-0" data-key=",">,</div>
                        <div class="heatmap-key error-0" data-key=".">.</div>
                        <div class="heatmap-key error-0" data-key="/">/</div>
                    </div>
                    <div class="heatmap-row">
                        <div class="heatmap-key error-0" data-key=" ">Spazio</div>
                    </div>
                </div>
                <div class="heatmap-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e8f5e8;"></div>
                        <span>Nessun errore</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fff3cd;"></div>
                        <span>1-3 errori</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fd79a8;"></div>
                        <span>4+ errori</span>
                    </div>
                </div>
                <div id="error-details"></div>
            </div>
        </div>

        <!-- Game Modes Section -->
        <div class="section" id="modes-section">
            <div class="game-modes">
                <div class="mode-card" data-mode="survival">
                    <div class="mode-icon">‚ö°</div>
                    <div class="mode-title">Survival Mode</div>
                    <div class="mode-description">Digita senza errori il pi√π a lungo possibile. Ogni errore riduce le tue vite!</div>
                    <div class="mode-settings">
                        <label>Vite: <select id="survival-lives"><option>3</option><option>5</option><option>10</option></select></label>
                    </div>
                </div>
                <div class="mode-card" data-mode="speed">
                    <div class="mode-icon">üèÉ</div>
                    <div class="mode-title">Speed Race</div>
                    <div class="mode-description">Corsa contro il tempo! Digita pi√π parole possibili nel tempo limite.</div>
                    <div class="mode-settings">
                        <label>Tempo: <select id="speed-time"><option>60</option><option>120</option><option>300</option></select> sec</label>
                    </div>
                </div>
                <div class="mode-card" data-mode="accuracy">
                    <div class="mode-icon">üéØ</div>
                    <div class="mode-title">Accuracy Challenge</div>
                    <div class="mode-description">Mantieni la precisione al 100%! Un errore e devi ricominciare.</div>
                    <div class="mode-settings">
                        <label>Lunghezza: <select id="accuracy-length"><option>100</option><option>250</option><option>500</option></select> caratteri</label>
                    </div>
                </div>
                <div class="mode-card" data-mode="zen">
                    <div class="mode-icon">üßò</div>
                    <div class="mode-title">Zen Mode</div>
                    <div class="mode-description">Modalit√† rilassante senza timer n√© pressioni. Solo tu e la tastiera.</div>
                </div>
                <div class="mode-card" data-mode="daily">
                    <div class="mode-icon">üìÖ</div>
                    <div class="mode-title">Daily Challenge</div>
                    <div class="mode-description">Sfida giornaliera con obiettivi specifici. Nuova sfida ogni giorno!</div>
                    <div id="daily-challenge-info"></div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="startSelectedMode()">üéÆ Inizia Modalit√†</button>
            </div>
        </div>

        <!-- Text Categories Section -->
        <div class="section" id="texts-section">
            <div class="text-categories">
                <div class="category-card selected" data-category="generale">
                    <div class="category-icon">üìù</div>
                    <div class="category-title">Generale</div>
                    <div class="category-count">18 testi (5C+7M+6L)</div>
                </div>
                <div class="category-card" data-category="business">
                    <div class="category-icon">üíº</div>
                    <div class="category-title">Business</div>
                    <div class="category-count">18 testi (5C+6M+7L)</div>
                </div>
                <div class="category-card" data-category="programmazione">
                    <div class="category-icon">üíª</div>
                    <div class="category-title">Programmazione</div>
                    <div class="category-count">18 testi (5C+6M+7L)</div>
                </div>
                <div class="category-card" data-category="letteratura">
                    <div class="category-icon">üìñ</div>
                    <div class="category-title">Letteratura</div>
                    <div class="category-count">17 testi (5C+5M+7L)</div>
                </div>
                <div class="category-card" data-category="giornalismo">
                    <div class="category-icon">üì∞</div>
                    <div class="category-title">Giornalismo</div>
                    <div class="category-count">17 testi (5C+5M+7L)</div>
                </div>
                <div class="category-card" data-category="scientifico">
                    <div class="category-icon">üî¨</div>
                    <div class="category-title">Scientifico</div>
                    <div class="category-count">17 testi (5C+5M+7L)</div>
                </div>
                <div class="category-card" data-category="custom">
                    <div class="category-icon">üìÅ</div>
                    <div class="category-title">Testi Personalizzati</div>
                    <div class="category-count" id="customTextsCount">0 testi</div>
                </div>
            </div>

            <div class="import-area" onclick="document.getElementById('fileInput').click()">
                <h3>üìÅ Importa Testo Personalizzato</h3>
                <p>Clicca per selezionare un file PDF o TXT</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    ‚ÑπÔ∏è Dopo il caricamento, il file verr√† automaticamente selezionato e potrai usarlo cliccando "Inizia"
                </p>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.pdf" onchange="handleFileImport(event)">
            </div>

            <div class="custom-texts" id="customTexts"></div>

            <div id="customTextStatus" style="display: none; padding: 15px; background: #e8f5e9; border-radius: 10px; margin-top: 20px;">
                <h3 style="color: #2e7d32; margin: 0 0 10px 0;">‚úÖ Testi Personalizzati Pronti</h3>
                <p style="margin: 0; color: #666;">
                    <strong id="customSentenceCount">0</strong> frasi disponibili dal tuo file.
                    <br>Clicca "üéÆ Inizia" nella sezione Pratica per usarle!
                </p>
            </div>
        </div>

        <!-- Keyboard Display -->
        <div class="keyboard-container" id="keyboardContainer" style="display: none;">
            <div class="keyboard-toggle">
                <h3>üéØ Guida Tastiera - Zone delle Dita</h3>
            </div>

            <div class="keyboard">
                <div class="keyboard-row">
                    <div class="key" data-key="`">`<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="1">1<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="2">2<span class="finger-zone">üîµ</span></div>
                    <div class="key" data-key="3">3<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="4">4<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="5">5<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="6">6<span class="finger-zone">üü°</span></div>
                    <div class="key" data-key="7">7<span class="finger-zone">üü°</span></div>
                    <div class="key" data-key="8">8<span class="finger-zone">üü†</span></div>
                    <div class="key" data-key="9">9<span class="finger-zone">üî¥</span></div>
                    <div class="key" data-key="0">0<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="-">-<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="=">=<span class="finger-zone">üü£</span></div>
                    <div class="key backspace" data-key="Backspace">‚å´</div>
                </div>
                <div class="keyboard-row">
                    <div class="key tab" data-key="Tab">Tab</div>
                    <div class="key" data-key="q">Q<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="w">W<span class="finger-zone">üîµ</span></div>
                    <div class="key" data-key="e">E<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="r">R<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="t">T<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="y">Y<span class="finger-zone">üü°</span></div>
                    <div class="key" data-key="u">U<span class="finger-zone">üü°</span></div>
                    <div class="key" data-key="i">I<span class="finger-zone">üü†</span></div>
                    <div class="key" data-key="o">O<span class="finger-zone">üî¥</span></div>
                    <div class="key" data-key="p">P<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="[">[<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="]">[<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="\">\<span class="finger-zone">üü£</span></div>
                </div>
                <div class="keyboard-row">
                    <div class="key caps" data-key="CapsLock">Caps</div>
                    <div class="key" data-key="a">A<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="s">S<span class="finger-zone">üîµ</span></div>
                    <div class="key" data-key="d">D<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="f">F<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="g">G<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="h">H<span class="finger-zone">üü°</span></div>
                    <div class="key" data-key="j">J<span class="finger-zone">üü°</span></div>
                    <div class="key" data-key="k">K<span class="finger-zone">üü†</span></div>
                    <div class="key" data-key="l">L<span class="finger-zone">üî¥</span></div>
                    <div class="key" data-key=";">;<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="'">'<span class="finger-zone">üü£</span></div>
                    <div class="key enter" data-key="Enter">Enter</div>
                </div>
                <div class="keyboard-row">
                    <div class="key shift" data-key="Shift">Shift</div>
                    <div class="key" data-key="z">Z<span class="finger-zone">üü£</span></div>
                    <div class="key" data-key="x">X<span class="finger-zone">üîµ</span></div>
                    <div class="key" data-key="c">C<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="v">V<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="b">B<span class="finger-zone">üü¢</span></div>
                    <div class="key" data-key="n">N<span class="finger-zone">üü°</span></div>
                    <div class="key" data-key="m">M<span class="finger-zone">üü°</span></div>
                    <div class="key" data-key=",">,<span class="finger-zone">üü†</span></div>
                    <div class="key" data-key=".">.<span class="finger-zone">üî¥</span></div>
                    <div class="key" data-key="/">/<span class="finger-zone">üü£</span></div>
                    <div class="key shift" data-key="Shift">Shift</div>
                </div>
                <div class="keyboard-row">
                    <div class="key ctrl" data-key="Control">Ctrl</div>
                    <div class="key alt" data-key="Alt">Alt</div>
                    <div class="key space" data-key=" ">Spazio</div>
                    <div class="key alt" data-key="Alt">Alt</div>
                    <div class="key ctrl" data-key="Control">Ctrl</div>
                </div>
            </div>

            <div class="finger-legend">
                <div class="finger-item">
                    <div class="finger-color" style="background: #9c27b0;"></div>
                    <span>üü£ Mignolo</span>
                </div>
                <div class="finger-item">
                    <div class="finger-color" style="background: #2196f3;"></div>
                    <span>üîµ Anulare</span>
                </div>
                <div class="finger-item">
                    <div class="finger-color" style="background: #4caf50;"></div>
                    <span>üü¢ Medio</span>
                </div>
                <div class="finger-item">
                    <div class="finger-color" style="background: #ffeb3b;"></div>
                    <span>üü° Indice</span>
                </div>
                <div class="finger-item">
                    <div class="finger-color" style="background: #ff9800;"></div>
                    <span>üü† Medio Dx</span>
                </div>
                <div class="finger-item">
                    <div class="finger-color" style="background: #f44336;"></div>
                    <span>üî¥ Anulare Dx</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <h2>üéâ Livello Completato!</h2>
            <div class="rewards-container">
                <div class="reward-item">
                    <div>‚≠ê XP Guadagnati</div>
                    <div style="font-size: 1.5em; font-weight: bold;" id="xpGained">0</div>
                </div>
                <div class="reward-item">
                    <div>üí∞ Monete</div>
                    <div style="font-size: 1.5em; font-weight: bold;" id="coinsGained">0</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="closeModal()">Continua</button>
        </div>
    </div>

    <!-- Audio elements -->
    <audio id="keySound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiS2Oy9diMFl2+z" type="audio/wav">
    </audio>

    <audio id="errorSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRiQCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQACAAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u" type="audio/wav">
    </audio>

    <audio id="comboSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRkQFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YSAFAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgA==" type="audio/wav">
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Game state
        let gameState = {
            // Player stats
            playerLevel: 1,
            playerXP: 0,
            playerXPToNext: 100,
            playerTitle: "Apprendista Dattilografo",
            coins: 0,
            totalStars: 0,
            highScore: 0,

            // Current game
            currentText: "",
            currentIndex: 0,
            startTime: null,
            errors: 0,
            totalChars: 0,
            score: 0,
            combo: 0,
            maxCombo: 0,
            comboMultiplier: 1,
            isActive: false,

            // Settings
            soundEnabled: true,
            currentTheme: 'default',
            currentSection: 'practice',
            selectedGameMode: null,
            selectedTextCategory: 'generale',

            // Analytics data
            errorsByKey: {},
            sessionHistory: [],
            fingerPerformance: {},
            customTexts: [],
            keystrokeTimes: [],
            currentKeystrokeTimes: [],

            // Mascot
            mascotMood: 'normal',
            mascotMessages: [
                "Forza! Ce la puoi fare! üí™",
                "Wow, sei velocissimo! ‚ö°",
                "Attento agli errori! üëÄ",
                "Incredibile combo! üî•",
                "Stai migliorando! üìà",
                "Fantastico! üåü",
                "Non mollare! üíñ"
            ]
        };

        // Player titles by level
        const playerTitles = [
            "Apprendista Dattilografo",
            "Studente Diligente",
            "Praticante Veloce",
            "Digitatore Esperto",
            "Maestro delle Dita",
            "Velocista Digitale",
            "Ninja della Tastiera",
            "Campione di Velocit√†",
            "Leggenda Vivente",
            "Dio della Dattilografia"
        ];

        // Text database by category
        const textDatabase = {
            generale: [
                // CORTI (< 60 caratteri)
                "Il gatto corre veloce.",
                "La musica √® bella.",
                "Oggi fa bel tempo.",
                "Leggo un libro interessante.",
                "Mi piace camminare nel parco.",

                // MEDI (60-120 caratteri)
                "La programmazione richiede pazienza e dedizione costante per ottenere buoni risultati.",
                "Nella vita bisogna sempre credere nei propri sogni e non arrendersi mai alle difficolt√†.",
                "L'intelligenza artificiale sta cambiando il mondo moderno in modo rapido e profondo.",
                "Praticare ogni giorno migliora le tue abilit√† di battitura e aumenta la velocit√†.",
                "Il sole splende luminoso nel cielo azzurro di questa mattina primaverile e serena.",
                "La musica classica ha il potere di rilassare mente e corpo dopo una giornata stressante.",
                "Durante le vacanze estive amo passeggiare lungo la spiaggia e guardare il tramonto.",

                // LUNGHI (> 120 caratteri)
                "Imparare una nuova lingua apre la mente a nuove culture, opportunit√† interessanti e permette di comunicare con persone di tutto il mondo creando legami profondi.",
                "La natura offre paesaggi mozzafiato che ispirano artisti e fotografi di tutto il mondo, regalando emozioni uniche e irripetibili che rimangono impresse nella memoria.",
                "L'esercizio fisico regolare contribuisce al benessere generale del corpo e della mente, migliorando la qualit√† della vita e prevenendo numerose malattie croniche.",
                "La lettura stimola l'immaginazione, arricchisce il vocabolario in modo significativo e permette di viaggiare con la mente verso mondi fantastici e realt√† sconosciute.",
                "L'amicizia vera si basa sulla fiducia reciproca, sul sostegno nei momenti difficili della vita e sulla capacit√† di condividere gioie e dolori senza giudizio.",
                "Viaggiare permette di scoprire nuovi luoghi, culture diverse, tradizioni affascinanti e di creare ricordi indimenticabili che arricchiscono la propria esperienza di vita.",
                "La cucina italiana √® famosa nel mondo per la sua variet√† di piatti tradizionali, saporiti e genuini che rappresentano l'eccellenza gastronomica e la passione culinaria.",
                "Il tempo libero dovrebbe essere dedicato alle proprie passioni, agli hobby che ci rendono felici e alle attivit√† che permettono di esprimere la propria creativit√† personale."
            ],
            business: [
                // CORTI (< 60 caratteri)
                "Il ROI √® positivo.",
                "Meeting alle tre.",
                "Budget approvato oggi.",
                "Vendite in crescita.",
                "Team molto produttivo.",

                // MEDI (60-120 caratteri)
                "La strategia aziendale deve essere allineata agli obiettivi di mercato per avere successo.",
                "Il ROI di questo progetto supera le aspettative iniziali del management e degli investitori.",
                "Le vendite del primo trimestre mostrano una crescita del venti percento rispetto all'anno scorso.",
                "Il customer service rappresenta un elemento chiave per la fidelizzazione dei clienti.",
                "Il budget annuale deve essere approvato entro la fine del mese corrente dalla direzione.",
                "Il marketing digitale √® fondamentale per raggiungere il target di riferimento moderno online.",

                // LUNGHI (> 120 caratteri)
                "La presentazione al board di amministrazione √® prevista per marted√¨ prossimo e richieder√† una preparazione accurata di tutti i dati finanziari e strategici dell'azienda.",
                "Il report trimestrale evidenzia un incremento significativo della produttivit√† aziendale grazie all'implementazione di nuovi processi e tecnologie innovative nel flusso di lavoro.",
                "La negoziazione del contratto richiede attenzione ai dettagli, competenze specifiche e una profonda conoscenza delle dinamiche di mercato per ottenere condizioni vantaggiose.",
                "La gestione delle risorse umane influenza direttamente il successo organizzativo attraverso la selezione, formazione e motivazione dei talenti all'interno dell'azienda.",
                "Il piano di espansione internazionale prevede l'apertura di cinque nuove sedi operative in Europa e Asia per consolidare la presenza globale del brand sul mercato.",
                "L'analisi SWOT fornisce una panoramica completa dei punti di forza, debolezza, opportunit√† e minacce aziendali per sviluppare strategie competitive efficaci.",
                "La supply chain deve essere ottimizzata per ridurre i costi operativi, migliorare l'efficienza logistica e garantire tempi di consegna rapidi ai clienti finali."
            ],
            programmazione: [
                // CORTI (< 60 caratteri)
                "let x = 10;",
                "const name = 'Mario';",
                "return true;",
                "console.log('Hello');",
                "const arr = [1, 2, 3];",

                // MEDI (60-120 caratteri)
                "function calculateSum(a, b) { return a + b; }",
                "const user = { name: 'Mario', age: 30, city: 'Milano' };",
                "if (condition === true) { console.log('Condizione verificata'); }",
                "for (let i = 0; i < array.length; i++) { processItem(array[i]); }",
                "const numbers = [1, 2, 3, 4, 5].map(n => n * 2).filter(n => n > 5);",
                "class Animal { constructor(name) { this.name = name; } }",

                // LUNGHI (> 120 caratteri)
                "async function fetchData() { const response = await fetch(url); if (!response.ok) throw new Error('Failed'); return response.json(); }",
                "const handleClick = (event) => { event.preventDefault(); const data = event.target.dataset; console.log('Clicked:', data); updateState(data); };",
                "try { const result = JSON.parse(data); processResult(result); } catch (error) { console.error('Parse error:', error.message); handleError(error); }",
                "const reducer = (state, action) => { switch(action.type) { case 'INCREMENT': return { ...state, value: state.value + 1 }; default: return state; } };",
                "interface User { id: number; name: string; email: string; role: 'admin' | 'user'; createdAt: Date; isActive: boolean; }",
                "const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), delay); }; };",
                "export const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:3000'; export const MAX_RETRIES = parseInt(process.env.MAX_RETRIES) || 3;"
            ],
            letteratura: [
                // CORTI (< 60 caratteri)
                "Era una notte buia.",
                "Il mare era calmo.",
                "Chiamatemi Ismaele.",
                "In principio era il Verbo.",
                "Tutte le famiglie felici.",

                // MEDI (60-120 caratteri)
                "Nel mezzo del cammin di nostra vita mi ritrovai per una selva oscura che la diritta via.",
                "Era il migliore dei tempi, era il peggiore dei tempi secondo il grande Charles Dickens.",
                "Il fu Mattia Pascal √® uno dei capolavori della letteratura italiana del Novecento moderno.",
                "La divina commedia √® strutturata in tre cantiche principali: Inferno, Purgatorio e Paradiso.",
                "L'Orlando furioso di Ludovico Ariosto celebra le gesta dei paladini di Francia medievali.",

                // LUNGHI (> 120 caratteri)
                "L'amore ai tempi del colera narra una storia romantica che attraversa decenni e continenti, esplorando la persistenza dell'amore vero attraverso il tempo e le difficolt√†.",
                "I promessi sposi rappresenta il romanzo storico pi√π importante della letteratura italiana, descrivendo la vita nel Seicento lombardo con precisione storica e passione narrativa.",
                "Cent'anni di solitudine √® un esempio magistrale di realismo magico latinoamericano che racconta la saga della famiglia Buend√≠a attraverso generazioni e destini intrecciati.",
                "Il nome della rosa unisce il mistero medievale alla riflessione filosofica e teologica, creando un capolavoro letterario che esplora fede, ragione e conoscenza umana.",
                "Le avventure di Pinocchio rappresentano una pietra miliare della letteratura per ragazzi italiana, narrando la trasformazione di un burattino ribelle in un bambino vero.",
                "Il Gattopardo descrive la Sicilia durante il Risorgimento con straordinaria profondit√† psicologica, mostrando come tutto deve cambiare affinch√© tutto rimanga uguale.",
                "Uno, nessuno e centomila esplora il tema dell'identit√† e della percezione di s√© attraverso la crisi esistenziale del protagonista Vitangelo Moscarda e la sua ricerca."
            ],
            giornalismo: [
                // CORTI (< 60 caratteri)
                "Nuovo record mondiale.",
                "Elezioni il prossimo mese.",
                "Il museo apre oggi.",
                "Borsa in forte crescita.",
                "Accordo storico raggiunto.",

                // MEDI (60-120 caratteri)
                "Il Presidente ha annunciato oggi nuove misure economiche straordinarie per la ripresa del paese.",
                "La squadra locale ha vinto il campionato dopo una stagione emozionante e molto combattuta.",
                "Gli scienziati hanno scoperto una nuova specie marina nell'Oceano Pacifico durante una spedizione.",
                "Il mercato azionario ha registrato oggi il massimo storico dell'anno con grande entusiasmo.",
                "Il nuovo museo d'arte contemporanea apre le porte al pubblico questo weekend con mostre esclusive.",

                // LUNGHI (> 120 caratteri)
                "La conferenza sul clima si √® conclusa con accordi importanti per il futuro del pianeta, impegnando i paesi a ridurre le emissioni di gas serra entro il 2030.",
                "La tecnologia 5G sta trasformando il modo in cui comunichiamo e lavoriamo quotidianamente, offrendo velocit√† di connessione senza precedenti e nuove opportunit√† digitali.",
                "Il festival del cinema presenta quest'anno una selezione di film internazionali straordinari provenienti da oltre cinquanta paesi con registi emergenti e affermati.",
                "L'economia globale mostra segnali di ripresa dopo un periodo di incertezza prolungata causato dalla pandemia, con investimenti in crescita e fiducia dei consumatori.",
                "Le elezioni politiche si terranno il prossimo mese con un'affluenza prevista molto alta grazie all'interesse crescente dei cittadini verso le questioni sociali.",
                "Il campione olimpico ha battuto il record mondiale nella gara dei cento metri piani con un tempo straordinario che ha lasciato tutti gli spettatori senza parole.",
                "La protezione ambientale √® diventata una priorit√† assoluta per i governi di tutto il mondo che stanno implementando politiche sostenibili e investimenti verdi."
            ],
            scientifico: [
                // CORTI (< 60 caratteri)
                "Il DNA √® una doppia elica.",
                "La gravit√† attrae i corpi.",
                "I neuroni trasmettono segnali.",
                "L'acqua bolle a 100 gradi.",
                "La luce viaggia veloce.",

                // MEDI (60-120 caratteri)
                "La fotosintesi clorofilliana converte l'energia luminosa in energia chimica nelle piante verdi.",
                "Il DNA contiene le informazioni genetiche necessarie per lo sviluppo di tutti gli organismi viventi.",
                "La teoria della relativit√† di Einstein ha rivoluzionato la fisica moderna e la nostra comprensione.",
                "I mitocondri sono considerati le centrali energetiche delle cellule eucariotiche degli organismi.",
                "La tavola periodica organizza gli elementi chimici per numero atomico in righe e colonne precise.",

                // LUNGHI (> 120 caratteri)
                "Il sistema solare √® composto dal Sole, otto pianeti principali, pianeti nani e numerosi corpi celesti minori come asteroidi, comete e meteoriti distribuiti nello spazio.",
                "La teoria dell'evoluzione di Darwin spiega l'origine e la diversit√† delle specie viventi attraverso il processo di selezione naturale e adattamento ambientale nel tempo.",
                "Le onde elettromagnetiche si propagano nel vuoto alla velocit√† della luce costante di circa trecentomila chilometri al secondo trasportando energia e informazioni.",
                "Il cervello umano contiene circa cento miliardi di neuroni interconnessi tra loro attraverso sinapsi che permettono la trasmissione di impulsi elettrici e chimici.",
                "La chimica organica studia i composti del carbonio e le loro reazioni caratteristiche, fondamentali per comprendere i processi biologici e sintetizzare nuovi materiali.",
                "Il principio di indeterminazione di Heisenberg pone limiti fondamentali alla precisione con cui possiamo misurare simultaneamente posizione e quantit√† di moto delle particelle.",
                "Gli ecosistemi mantengono l'equilibrio ecologico attraverso complesse interazioni tra organismi viventi, flussi di energia e cicli biogeochimici della materia organica."
            ]
        };

        // Finger mapping for keys
        const fingerMap = {
            'q': 'leftPinky', 'w': 'leftRing', 'e': 'leftMiddle', 'r': 'leftIndex', 't': 'leftIndex',
            'y': 'rightIndex', 'u': 'rightIndex', 'i': 'rightMiddle', 'o': 'rightRing', 'p': 'rightPinky',
            'a': 'leftPinky', 's': 'leftRing', 'd': 'leftMiddle', 'f': 'leftIndex', 'g': 'leftIndex',
            'h': 'rightIndex', 'j': 'rightIndex', 'k': 'rightMiddle', 'l': 'rightRing', ';': 'rightPinky',
            'z': 'leftPinky', 'x': 'leftRing', 'c': 'leftMiddle', 'v': 'leftIndex', 'b': 'leftIndex',
            'n': 'rightIndex', 'm': 'rightIndex', ',': 'rightMiddle', '.': 'rightRing', '/': 'rightPinky',
            '1': 'leftPinky', '2': 'leftRing', '3': 'leftMiddle', '4': 'leftIndex', '5': 'leftIndex',
            '6': 'rightIndex', '7': 'rightIndex', '8': 'rightMiddle', '9': 'rightRing', '0': 'rightPinky',
            ' ': 'thumbs'
        };

        // Initialize (kept for backward compatibility)
        function init() {
            initializeApp();
        }

        // Handle typing - SENZA CANCELLARE
        function handleTyping(e) {
            if (!gameState.isActive) return;

            const inputValue = e.target.value;

            // Conta caratteri corretti
            let correctChars = 0;
            let errors = 0;

            for (let i = 0; i < inputValue.length; i++) {
                if (i < gameState.currentText.length) {
                    if (inputValue[i].toLowerCase() === gameState.currentText[i].toLowerCase()) {
                        correctChars++;
                    } else {
                        errors++;
                        // TRACCIA L'ERRORE PER LA HEATMAP
                        trackKeyError(gameState.currentText[i]);
                    }
                }
            }

            gameState.currentIndex = correctChars;
            gameState.errors = errors;
            gameState.totalChars = inputValue.length;
            gameState.score = correctChars * 10;

            // Completato? (basta che arrivi alla fine, anche con errori)
            if (inputValue.length >= gameState.currentText.length) {
                // SALVA I DATI DELLA SESSIONE PER ANALYTICS
                const wpm = Math.round((correctChars / 5) / ((Date.now() - gameState.startTime) / 1000 / 60)) || 0;
                const accuracy = Math.round(((gameState.totalChars - gameState.errors) / gameState.totalChars) * 100) || 100;

                const sessionData = {
                    date: new Date().toISOString(),
                    wpm: wpm,
                    accuracy: accuracy,
                    errors: gameState.errors,
                    score: gameState.score,
                    textCategory: gameState.selectedTextCategory,
                    duration: (Date.now() - gameState.startTime) / 1000
                };

                gameState.sessionHistory.push(sessionData);
                if (gameState.sessionHistory.length > 50) {
                    gameState.sessionHistory = gameState.sessionHistory.slice(-50);
                }

                // AGGIORNA ANALYTICS
                updateHeatmap();
                saveGameState();

                // Nuova frase automaticamente
                setTimeout(() => {
                    const texts = getFilteredTexts();
                    gameState.currentText = texts[Math.floor(Math.random() * texts.length)];
                    gameState.currentIndex = 0;
                    gameState.startTime = Date.now(); // Reset timer
                    document.getElementById('typingInput').value = '';
                    updateTextDisplay();
                }, 1000);
                return;
            }

            updateTextDisplay();
            updateStats();
        }

        // Setup event listeners
        function setupEventListeners() {
            const input = document.getElementById('typingInput');
            input.addEventListener('input', handleTyping);
        }


        // Update text display
        function updateTextDisplay() {
            const display = document.getElementById('textDisplay');
            const input = document.getElementById('typingInput').value;
            let html = '';

            for (let i = 0; i < gameState.currentText.length; i++) {
                const char = gameState.currentText[i];
                let className = '';

                if (i < input.length) {
                    if (input[i].toLowerCase() === char.toLowerCase()) {
                        className = 'correct';
                    } else {
                        className = 'incorrect'; // ROSSO per errori
                    }
                } else if (i === input.length) {
                    className = 'current';
                }

                html += `<span class="${className}">${char}</span>`;
            }

            display.innerHTML = html;
            updateProgress();

            // Highlight next key
            if (input.length < gameState.currentText.length) {
                highlightNextKey(gameState.currentText[input.length]);
            }
        }

        // Update progress bar
        function updateProgress() {
            const progress = (gameState.currentIndex / gameState.currentText.length) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
        }

        // Update stats
        function updateStats() {
            const elapsedTime = (Date.now() - gameState.startTime) / 1000 / 60;
            const words = gameState.currentIndex / 5;
            const wpm = Math.round(words / elapsedTime) || 0;
            const accuracy = Math.round(((gameState.totalChars - gameState.errors) / gameState.totalChars) * 100) || 100;

            document.getElementById('wpm').textContent = wpm;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            document.getElementById('combo').textContent = gameState.combo;
            document.getElementById('score').textContent = gameState.score;

            // Update timer
            const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Complete level
        function completeLevel() {
            gameState.isActive = false;

            // Calculate rewards
            const xpGained = Math.floor(gameState.score / 10);
            const coinsGained = Math.floor(gameState.score / 50);

            gameState.playerXP += xpGained;
            gameState.coins += coinsGained;

            // Calculate rhythm and consistency metrics
            const rhythmData = calculateRhythmMetrics();
            const consistencyScore = calculateConsistencyScore();

            // Save session data for analytics
            const sessionData = {
                date: new Date().toISOString(),
                wpm: parseInt(document.getElementById('wpm').textContent),
                accuracy: parseInt(document.getElementById('accuracy').textContent.replace('%', '')),
                errors: gameState.errors,
                score: gameState.score,
                textCategory: gameState.selectedTextCategory,
                duration: (Date.now() - gameState.startTime) / 1000,
                rhythm: rhythmData,
                consistency: consistencyScore,
                keystrokeTimes: [...gameState.currentKeystrokeTimes]
            };
            gameState.sessionHistory.push(sessionData);
            if (gameState.sessionHistory.length > 50) {
                gameState.sessionHistory = gameState.sessionHistory.slice(-50);
            }

            // Check level up
            while (gameState.playerXP >= gameState.playerXPToNext) {
                levelUp();
            }

            // Update high score
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                document.getElementById('highScore').textContent = gameState.highScore;
            }

            saveGameState();
            updatePlayerUI();
            updateHeatmap();
            updateAnalytics();

            // Show results
            document.getElementById('xpGained').textContent = `+${xpGained}`;
            document.getElementById('coinsGained').textContent = `+${coinsGained}`;
            document.getElementById('resultModal').classList.add('active');

            updateMascot('happy');
            createParticles('heart', 10);
        }

        // Level up
        function levelUp() {
            gameState.playerXP -= gameState.playerXPToNext;
            gameState.playerLevel++;
            gameState.playerXPToNext = gameState.playerLevel * 150;
            gameState.playerTitle = playerTitles[Math.min(gameState.playerLevel - 1, playerTitles.length - 1)];

            // Show level up animation
            const levelUpAnim = document.getElementById('levelUpAnimation');
            levelUpAnim.classList.add('show');
            setTimeout(() => levelUpAnim.classList.remove('show'), 2000);

            playSound('comboSound');
            createParticles('star', 20);
        }

        // Update player UI
        function updatePlayerUI() {
            document.getElementById('levelBadge').textContent = gameState.playerLevel;
            document.getElementById('playerLevel').textContent = gameState.playerLevel;
            document.getElementById('playerTitle').textContent = gameState.playerTitle;
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('totalStars').textContent = gameState.totalStars;

            const xpPercent = (gameState.playerXP / gameState.playerXPToNext) * 100;
            document.getElementById('xpFill').style.width = `${xpPercent}%`;
            document.getElementById('xpText').textContent = `${gameState.playerXP} / ${gameState.playerXPToNext} XP`;
        }

        // Get filtered texts - VERSIONE SEMPLIFICATA SENZA FALLBACK
        function getFilteredTexts() {
            console.log('\n=== GET FILTERED TEXTS ===');
            const difficulty = document.getElementById('difficulty').value;
            const textLength = document.getElementById('textLength').value;
            console.log('Categoria:', gameState.selectedTextCategory);
            console.log('Difficolt√†:', difficulty);
            console.log('Lunghezza:', textLength);

            // Handle custom texts category - RITORNA TUTTE LE FRASI CUSTOM
            if (gameState.selectedTextCategory === 'custom') {
                console.log('‚Üí Using CUSTOM texts');

                if (gameState.customTexts.length === 0) {
                    console.error('‚ùå NO CUSTOM TEXTS FOUND!');
                    alert('Nessun testo personalizzato caricato! Carica un file nella sezione Testi.');
                    return textDatabase.generale;
                }

                console.log('Files loaded:', gameState.customTexts.length);

                // Split into sentences
                let customTextArray = [];
                gameState.customTexts.forEach((customText, fileIndex) => {
                    console.log('  Processing file ' + (fileIndex + 1) + ': ' + customText.name);

                    // Split by punctuation
                    let sentences = customText.content.split(/[.!?]+/);
                    sentences.forEach(s => {
                        const trimmed = s.trim();
                        if (trimmed.length >= 20) {  // Minimum 20 chars
                            customTextArray.push(trimmed + '.');
                        }
                    });
                });

                console.log('‚úÖ Custom texts split into', customTextArray.length, 'sentences');
                if (customTextArray.length > 0) {
                    console.log('First 3 samples:');
                    customTextArray.slice(0, 3).forEach((t, i) => {
                        console.log('  ' + (i+1) + '. (' + t.length + ' char) ' + t.substring(0, 60) + '...');
                    });
                }

                return customTextArray;
            }

            // Get all texts from selected category
            let allTexts = textDatabase[gameState.selectedTextCategory];
            if (!allTexts) {
                console.error('‚ùå Category not found:', gameState.selectedTextCategory);
                allTexts = textDatabase.generale;
            }
            console.log('Total texts in category:', allTexts.length);

            // PRIMO: Filtra per LUNGHEZZA (ignorando difficolt√† per ora)
            let filtered = [];
            if (textLength === 'corto') {
                filtered = allTexts.filter(text => text.length < 60);
                console.log('‚Üí Filter: LENGTH < 60');
            } else if (textLength === 'lungo') {
                filtered = allTexts.filter(text => text.length > 120);
                console.log('‚Üí Filter: LENGTH > 120');
            } else { // medio
                filtered = allTexts.filter(text => text.length >= 60 && text.length <= 120);
                console.log('‚Üí Filter: LENGTH 60-120');
            }

            console.log('After length filter:', filtered.length, 'texts found');

            if (filtered.length > 0) {
                console.log('Sample lengths:', filtered.map(t => t.length).slice(0, 5));
            } else {
                console.error('‚ùå NO TEXTS MATCH LENGTH FILTER!');
                console.log('Available lengths:', allTexts.map(t => t.length));
            }

            return filtered.length > 0 ? filtered : allTexts;
        }

        // Start game
        function startGame() {
            const texts = getFilteredTexts();

            if (!texts || texts.length === 0) {
                console.error('‚ùå NO TEXTS AVAILABLE!');
                alert('Errore: nessun testo disponibile!');
                return;
            }

            const randomIndex = Math.floor(Math.random() * texts.length);
            gameState.currentText = texts[randomIndex];

            console.log('\n=== GAME STARTED ===');
            console.log('Selected text ' + (randomIndex + 1) + '/' + texts.length);
            console.log('Length:', gameState.currentText.length, 'characters');
            console.log('Text:', gameState.currentText);
            console.log('==================\n');

            gameState.currentIndex = 0;
            gameState.startTime = Date.now();
            gameState.errors = 0;
            gameState.totalChars = 0;
            gameState.score = 0;
            gameState.combo = 0;
            gameState.comboMultiplier = 1;
            gameState.isActive = true;
            gameState.currentKeystrokeTimes = [];

            const input = document.getElementById('typingInput');
            input.disabled = false;
            input.value = '';
            input.focus();

            updateTextDisplay();
            updateMascot('normal');
            mascotSpeak("Iniziamo! Buona fortuna! üçÄ");
        }

        // Reset game
        function resetGame() {
            gameState.isActive = false;
            gameState.currentIndex = 0;
            document.getElementById('typingInput').disabled = true;
            document.getElementById('typingInput').value = '';
            document.getElementById('textDisplay').innerHTML = "Clicca 'Inizia' per cominciare la tua avventura!";
            document.getElementById('progress').style.width = '0%';
            updateMascot('normal');
        }

        // Create particle effect
        function createParticle(type) {
            const particle = document.createElement('div');
            particle.className = `particle ${type}`;
            particle.textContent = type === 'star' ? '‚≠ê' : '‚ù§Ô∏è';

            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;

            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.setProperty('--x', `${(Math.random() - 0.5) * 200}px`);
            particle.style.setProperty('--y', `${(Math.random() - 0.5) * 200}px`);

            document.body.appendChild(particle);

            setTimeout(() => particle.remove(), 1000);
        }

        // Create multiple particles
        function createParticles(type, count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => createParticle(type), i * 50);
            }
        }

        // Show combo
        function showCombo() {
            const comboDisplay = document.getElementById('comboDisplay');
            document.getElementById('comboMultiplier').textContent = gameState.comboMultiplier;
            comboDisplay.classList.add('active');

            setTimeout(() => {
                comboDisplay.classList.remove('active');
            }, 2000);
        }

        // Shake screen effect
        function shakeScreen() {
            document.body.style.animation = 'shake 0.3s';
            setTimeout(() => {
                document.body.style.animation = '';
            }, 300);
        }

        // Set theme
        function setTheme(theme, buttonElement) {
            document.body.className = `theme-${theme}`;
            gameState.currentTheme = theme;

            // Update theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Initialize theme-specific effects
            initializeThemeEffects();

            saveGameState();
            saveUserPreferences();
        }

        // Initialize theme effects
        function initializeThemeEffects() {
            const bgAnimation = document.getElementById('bgAnimation');
            bgAnimation.innerHTML = '';

            if (gameState.currentTheme === 'space') {
                // Create stars
                for (let i = 0; i < 100; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 3}s`;
                    bgAnimation.appendChild(star);
                }
            } else if (gameState.currentTheme === 'nature') {
                // Create falling leaves
                setInterval(() => {
                    if (gameState.currentTheme !== 'nature') return;
                    const leaf = document.createElement('div');
                    leaf.className = 'leaf';
                    leaf.style.left = `${Math.random() * 100}%`;
                    leaf.style.animationDuration = `${5 + Math.random() * 10}s`;
                    bgAnimation.appendChild(leaf);
                    setTimeout(() => leaf.remove(), 15000);
                }, 2000);
            } else if (gameState.currentTheme === 'ocean') {
                // Create bubbles
                setInterval(() => {
                    if (gameState.currentTheme !== 'ocean') return;
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    const size = 10 + Math.random() * 30;
                    bubble.style.width = `${size}px`;
                    bubble.style.height = `${size}px`;
                    bubble.style.left = `${Math.random() * 100}%`;
                    bubble.style.animationDuration = `${5 + Math.random() * 5}s`;
                    bgAnimation.appendChild(bubble);
                    setTimeout(() => bubble.remove(), 10000);
                }, 1000);
            }
        }

        // Mascot functions
        function updateMascot(mood) {
            const mascot = document.getElementById('mascot');
            mascot.className = `mascot ${mood}`;
            gameState.mascotMood = mood;
        }

        function mascotSpeak(message) {
            const speech = document.getElementById('mascotSpeech');
            speech.textContent = message;
            speech.classList.add('show');

            setTimeout(() => {
                speech.classList.remove('show');
            }, 3000);
        }

        function interactMascot() {
            const randomMessage = gameState.mascotMessages[Math.floor(Math.random() * gameState.mascotMessages.length)];
            mascotSpeak(randomMessage);
            updateMascot('excited');
            setTimeout(() => updateMascot('normal'), 1000);
        }

        // Sound functions
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            const icon = document.getElementById('soundIcon');
            const toggle = document.getElementById('soundToggle');

            if (gameState.soundEnabled) {
                icon.textContent = 'üîä';
                toggle.classList.remove('muted');
            } else {
                icon.textContent = 'üîá';
                toggle.classList.add('muted');
            }

            saveGameState();
        }

        function playSound(soundId) {
            if (!gameState.soundEnabled) return;

            const sound = document.getElementById(soundId);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log('Audio play failed:', e));
            }
        }

        // Modal functions
        function closeModal() {
            document.getElementById('resultModal').classList.remove('active');
        }

        function showShop() {
            alert('üõçÔ∏è Negozio in arrivo! Potrai comprare temi, mascotte e power-ups!');
        }

        function showAchievements() {
            alert('üèÜ Sistema trofei in arrivo! Sblocca achievement completando sfide!');
        }

        // Keyboard functions
        function toggleKeyboard() {
            const keyboard = document.getElementById('keyboardContainer');
            if (keyboard.style.display === 'none' || !keyboard.style.display) {
                keyboard.style.display = 'block';
            } else {
                keyboard.style.display = 'none';
            }
        }

        function highlightKey(key, pressed) {
            // Clean up key name for matching
            const cleanKey = key.toLowerCase();
            const keyElement = document.querySelector(`[data-key="${key}"]`) ||
                              document.querySelector(`[data-key="${cleanKey}"]`);

            if (keyElement) {
                if (pressed) {
                    keyElement.classList.add('pressed');
                } else {
                    keyElement.classList.remove('pressed');
                }
            }
        }

        function highlightNextKey(nextChar) {
            // Remove previous highlights
            document.querySelectorAll('.key.active').forEach(key => {
                key.classList.remove('active');
            });

            // Highlight next key
            const cleanChar = nextChar.toLowerCase();
            const keyElement = document.querySelector(`[data-key="${nextChar}"]`) ||
                              document.querySelector(`[data-key="${cleanChar}"]`) ||
                              document.querySelector(`[data-key=" "]`); // For space

            if (keyElement) {
                keyElement.classList.add('active');
            }
        }

        // Save/Load game state
        function saveGameState() {
            localStorage.setItem('typingGameState', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('typingGameState');
            if (saved) {
                const loaded = JSON.parse(saved);
                Object.assign(gameState, loaded);
            }
        }

        // Navigation functions
        function switchSection(sectionName) {
            console.log('\n--- SWITCH SECTION ---');
            console.log('From:', gameState.currentSection, '‚Üí To:', sectionName);
            console.log('Current category:', gameState.selectedTextCategory);

            gameState.currentSection = sectionName;

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update sections
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${sectionName}-section`).classList.add('active');

            if (sectionName === 'analytics') {
                updateAnalytics();
            }

            console.log('Section switched. Category still:', gameState.selectedTextCategory);
            console.log('--------------------\n');
        }

        // Analytics functions
        function trackKeyError(key) {
            const cleanKey = key.toLowerCase();
            if (!gameState.errorsByKey[cleanKey]) {
                gameState.errorsByKey[cleanKey] = 0;
            }
            gameState.errorsByKey[cleanKey]++;
        }

        function updateHeatmap() {
            document.querySelectorAll('.heatmap-key').forEach(key => {
                const keyChar = key.dataset.key;
                const errorCount = gameState.errorsByKey[keyChar] || 0;

                // Reset classes
                key.classList.remove('error-0', 'error-1', 'error-2');

                if (errorCount === 0) {
                    key.classList.add('error-0');
                } else if (errorCount <= 3) {
                    key.classList.add('error-1');
                } else {
                    key.classList.add('error-2');
                }
            });

            // Update error details
            updateErrorDetails();
        }

        function updateErrorDetails() {
            const errorDetails = document.getElementById('error-details');
            const sortedErrors = Object.entries(gameState.errorsByKey)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            let html = '<h4>Tasti con pi√π errori:</h4>';
            sortedErrors.forEach(([key, count]) => {
                html += `<div class="error-item">
                    <div class="error-key">${key.toUpperCase()}</div>
                    <div class="error-count">${count}</div>
                </div>`;
            });

            errorDetails.innerHTML = html;
        }

        function updateAnalytics() {
            updateHeatmap();
            updatePerformanceCharts();
            updateRhythmAnalysis();
        }

        function updatePerformanceCharts() {
            const chartContainer = document.getElementById('performance-charts');

            if (gameState.sessionHistory.length === 0) {
                chartContainer.innerHTML = '<p>Nessun dato disponibile. Completa qualche sessione di pratica!</p>';
                return;
            }

            chartContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <canvas id="progressChart" width="400" height="200"></canvas>
                    <canvas id="consistencyChart" width="400" height="200"></canvas>
                </div>
                <div id="rhythmAnalysis"></div>
            `;

            // Progress Chart
            const ctx1 = document.getElementById('progressChart').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: gameState.sessionHistory.map((_, i) => `Sessione ${i + 1}`),
                    datasets: [{
                        label: 'WPM',
                        data: gameState.sessionHistory.map(session => session.wpm),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'Precisione %',
                        data: gameState.sessionHistory.map(session => session.accuracy),
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Progressi nel Tempo'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Consistency Chart
            const ctx2 = document.getElementById('consistencyChart').getContext('2d');
            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: gameState.sessionHistory.map((_, i) => `Sessione ${i + 1}`),
                    datasets: [{
                        label: 'Consistency Score',
                        data: gameState.sessionHistory.map(session => session.consistency || 0),
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Consistenza nel Tempo'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Rhythm Analysis
            updateRhythmAnalysis();
        }

        // Game modes functions
        function startSelectedMode() {
            const selectedMode = document.querySelector('.mode-card.selected');
            if (!selectedMode) {
                alert('Seleziona una modalit√† di gioco!');
                return;
            }

            gameState.selectedGameMode = selectedMode.dataset.mode;

            // Switch to practice section and start game
            switchSection('practice');
            setTimeout(startGame, 500);
        }

        // Text category functions
        function selectTextCategory(category, cardElement) {
            gameState.selectedTextCategory = category;

            // Update UI
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (cardElement) {
                cardElement.classList.add('selected');
            }

            saveUserPreferences();
        }

        // File import functions
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('üìÇ File selected:', file.name, 'Type:', file.type);

            if (file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    console.log('üìÑ File read, length:', text.length);

                    if (text.trim().length < 10) {
                        alert('Il file √® troppo corto! Inserisci un testo di almeno 10 caratteri.');
                        return;
                    }
                    const customText = {
                        id: Date.now(),
                        name: file.name,
                        content: text.substring(0, 5000), // Limit to 5000 characters
                        date: new Date().toLocaleDateString()
                    };

                    gameState.customTexts.push(customText);

                    console.log('\n=== FILE TXT CARICATO ===');
                    console.log('Nome file:', customText.name);
                    console.log('Lunghezza:', customText.content.length, 'caratteri');
                    console.log('Contenuto (primi 100):', customText.content.substring(0, 100));
                    console.log('Totale file custom:', gameState.customTexts.length);

                    updateCustomTextsUI();
                    saveGameState();

                    // Auto-select custom category
                    gameState.selectedTextCategory = 'custom';
                    console.log('‚úÖ gameState.selectedTextCategory = "custom"');

                    document.querySelectorAll('.category-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    const customCard = document.querySelector('[data-category="custom"]');
                    if (customCard) {
                        customCard.classList.add('selected');
                        console.log('‚úÖ Card "Testi Personalizzati" selezionata visivamente');
                    }

                    // Show status
                    showCustomTextStatus();
                    console.log('======================\n');

                    showNotification('‚úÖ File caricato! Vai su Pratica e premi Inizia.');
                };
                reader.readAsText(file);
            } else if (file.type === 'application/pdf') {
                try {
                    showNotification('üìÑ Caricamento PDF in corso...');
                    const arrayBuffer = await file.arrayBuffer();

                    // Configure PDF.js worker
                    if (typeof pdfjsLib !== 'undefined') {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let fullText = '';

                        // Extract text from all pages (max 10 pages)
                        const numPages = Math.min(pdf.numPages, 10);
                        for (let i = 1; i <= numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + ' ';
                        }

                        if (fullText.trim().length < 10) {
                            alert('Il PDF non contiene testo leggibile o √® troppo corto!');
                            return;
                        }

                        const customText = {
                            id: Date.now(),
                            name: file.name,
                            content: fullText.trim().substring(0, 5000),
                            date: new Date().toLocaleDateString()
                        };

                        gameState.customTexts.push(customText);
                        console.log('üíæ PDF saved to gameState.customTexts');
                        console.log('Total custom texts:', gameState.customTexts.length);
                        console.log('PDF content preview:', customText.content.substring(0, 100));

                        updateCustomTextsUI();
                        saveGameState();

                        // Auto-select custom category
                        gameState.selectedTextCategory = 'custom';
                        document.querySelectorAll('.category-card').forEach(card => {
                            card.classList.remove('selected');
                        });
                        const customCard = document.querySelector('[data-category="custom"]');
                        if (customCard) {
                            customCard.classList.add('selected');
                            console.log('‚úÖ Auto-selected custom category');
                        }

                        // Show status with sentence count
                        showCustomTextStatus();
                        showNotification('‚úÖ PDF caricato e pronto!');
                    } else {
                        alert('Errore: PDF.js non √® stato caricato correttamente. Ricarica la pagina e riprova.');
                    }
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    alert('Errore durante il caricamento del PDF: ' + error.message);
                }
            } else {
                alert('Formato file non supportato! Usa file TXT o PDF.');
            }
        }

        function updateCustomTextsUI() {
            const container = document.getElementById('customTexts');
            const countElement = document.getElementById('customTextsCount');

            // Update count in category card
            if (countElement) {
                const count = gameState.customTexts.length;
                countElement.textContent = `${count} ${count === 1 ? 'testo' : 'testi'}`;
            }

            if (gameState.customTexts.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<h3>üìö Testi Personalizzati</h3>';
            gameState.customTexts.forEach(text => {
                html += `<div class="custom-text-item">
                    <div>
                        <strong>${text.name}</strong> - ${text.date}
                        <div class="text-preview">${text.content.substring(0, 100)}...</div>
                    </div>
                    <button class="delete-btn" onclick="deleteCustomText(${text.id})">√ó</button>
                </div>`;
            });

            container.innerHTML = html;
        }

        function deleteCustomText(id) {
            gameState.customTexts = gameState.customTexts.filter(text => text.id !== id);
            updateCustomTextsUI();
            saveGameState();
        }

        // Event listeners for new features
        function setupNewEventListeners() {
            // Mode selection
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Category selection
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function() {
                    const category = this.dataset.category;
                    selectTextCategory(category, this);
                });
            });

            // Save preferences when dropdowns change
            document.getElementById('difficulty').addEventListener('change', saveUserPreferences);
            document.getElementById('textLength').addEventListener('change', saveUserPreferences);
        }

        // Modified init function
        function initializeApp() {
            loadGameState();
            updatePlayerUI();
            setupEventListeners();
            setupNewEventListeners();
            initializeThemeEffects();
            updateCustomTextsUI();
            updateHeatmap();
            loadUserPreferences();
            showCustomTextStatus(); // Show if custom texts are loaded
        }

        // Save and load user preferences
        function saveUserPreferences() {
            const preferences = {
                difficulty: document.getElementById('difficulty').value,
                textLength: document.getElementById('textLength').value,
                theme: gameState.currentTheme,
                category: gameState.selectedTextCategory
            };
            localStorage.setItem('typingGamePreferences', JSON.stringify(preferences));
        }

        function loadUserPreferences() {
            const saved = localStorage.getItem('typingGamePreferences');
            if (saved) {
                try {
                    const preferences = JSON.parse(saved);

                    // Restore dropdown values
                    if (preferences.difficulty) {
                        document.getElementById('difficulty').value = preferences.difficulty;
                    }
                    if (preferences.textLength) {
                        document.getElementById('textLength').value = preferences.textLength;
                    }

                    // Restore theme
                    if (preferences.theme && preferences.theme !== gameState.currentTheme) {
                        const themeBtn = document.querySelector(`[onclick*="setTheme('${preferences.theme}')"]`);
                        if (themeBtn) {
                            setTheme(preferences.theme, themeBtn);
                        }
                    }

                    // Restore category selection
                    if (preferences.category) {
                        gameState.selectedTextCategory = preferences.category;
                        const categoryCard = document.querySelector(`[data-category="${preferences.category}"]`);
                        if (categoryCard) {
                            document.querySelectorAll('.category-card').forEach(card => {
                                card.classList.remove('selected');
                            });
                            categoryCard.classList.add('selected');
                        }
                    }
                } catch (e) {
                    console.error('Error loading preferences:', e);
                }
            }
        }

        // Rhythm and consistency analysis functions
        function calculateRhythmMetrics() {
            if (gameState.currentKeystrokeTimes.length < 3) return { avgInterval: 0, variance: 0 };

            const intervals = [];
            for (let i = 1; i < gameState.currentKeystrokeTimes.length; i++) {
                intervals.push(gameState.currentKeystrokeTimes[i] - gameState.currentKeystrokeTimes[i - 1]);
            }

            const avgInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;
            const variance = intervals.reduce((sum, interval) => sum + Math.pow(interval - avgInterval, 2), 0) / intervals.length;

            return { avgInterval, variance, intervals };
        }

        function calculateConsistencyScore() {
            if (gameState.currentKeystrokeTimes.length < 10) return 100;

            const rhythmData = calculateRhythmMetrics();
            const coefficientOfVariation = Math.sqrt(rhythmData.variance) / rhythmData.avgInterval;

            // Convert coefficient of variation to consistency score (0-100)
            // Lower variation = higher consistency
            const consistencyScore = Math.max(0, Math.min(100, 100 - (coefficientOfVariation * 100)));

            return Math.round(consistencyScore);
        }

        function updateRhythmAnalysis() {
            const rhythmContainer = document.getElementById('rhythmAnalysis');

            if (gameState.sessionHistory.length === 0) {
                rhythmContainer.innerHTML = '';
                return;
            }

            const latestSession = gameState.sessionHistory[gameState.sessionHistory.length - 1];
            const avgConsistency = gameState.sessionHistory.reduce((sum, session) => sum + (session.consistency || 0), 0) / gameState.sessionHistory.length;

            let rhythmDescription = '';
            if (avgConsistency >= 80) {
                rhythmDescription = 'üéÜ Eccellente! Il tuo ritmo di digitazione √® molto stabile.';
            } else if (avgConsistency >= 60) {
                rhythmDescription = 'üëç Buono! Stai mantenendo un ritmo abbastanza costante.';
            } else if (avgConsistency >= 40) {
                rhythmDescription = '‚ö†Ô∏è Da migliorare. Cerca di mantenere un ritmo pi√π uniforme.';
            } else {
                rhythmDescription = 'üìä Focus sul ritmo! Prova a digitare con intervalli pi√π regolari.';
            }

            rhythmContainer.innerHTML = `
                <div class="analytics-card">
                    <div class="analytics-title">üéµ Analisi Ritmo e Consistenza</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                        <div class="stat-box">
                            <div class="stat-label">Consistency Score</div>
                            <div class="stat-value">${Math.round(avgConsistency)}%</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Ultima Sessione</div>
                            <div class="stat-value">${latestSession.consistency || 0}%</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Trend</div>
                            <div class="stat-value">${getTrendIcon(gameState.sessionHistory.map(s => s.consistency || 0))}</div>
                        </div>
                    </div>
                    <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; margin-top: 15px;">
                        <strong>Feedback:</strong> ${rhythmDescription}
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        <p><strong>Suggerimenti per migliorare:</strong></p>
                        <ul>
                            <li>Mantieni un ritmo costante evitando accelerazioni e rallentamenti</li>
                            <li>Concentrati sulla fluidit√† piuttosto che sulla velocit√† pura</li>
                            <li>Fai pause regolari per evitare la fatica che porta a inconsistenza</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function getTrendIcon(values) {
            if (values.length < 3) return '‚ûñ';

            const recent = values.slice(-3);
            const trend = recent[2] - recent[0];

            if (trend > 5) return 'üìà Miglioramento';
            if (trend < -5) return 'üìâ In calo';
            return 'üìä Stabile';
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            container.appendChild(notification);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Show custom text status
        function showCustomTextStatus() {
            if (gameState.customTexts.length === 0) {
                document.getElementById('customTextStatus').style.display = 'none';
                return;
            }

            // Calculate how many sentences will be generated
            let sentenceCount = 0;
            gameState.customTexts.forEach(customText => {
                let sentences = customText.content.split(/[.!?]\s+/);
                if (sentences.length <= 1) {
                    // Count chunks
                    const words = customText.content.split(/\s+/);
                    let chunk = '';
                    words.forEach(word => {
                        if ((chunk + word).length > 100 && chunk.length > 0) {
                            sentenceCount++;
                            chunk = word + ' ';
                        } else {
                            chunk += word + ' ';
                        }
                    });
                    if (chunk.trim().length > 0) {
                        sentenceCount++;
                    }
                } else {
                    sentences.forEach(s => {
                        if (s.trim().length >= 10) {
                            sentenceCount++;
                        }
                    });
                }
            });

            document.getElementById('customSentenceCount').textContent = sentenceCount;
            document.getElementById('customTextStatus').style.display = 'block';

            console.log('üìä Status: ' + sentenceCount + ' frasi generate da ' + gameState.customTexts.length + ' file');
        }

        // Initialize on load
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
